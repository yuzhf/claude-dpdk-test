# DPDK 多网口多队列收发包程序

这是一个基于DPDK的高性能网络数据包处理程序，支持多网口、多队列、多核心的生产者-消费者模式架构。

## 功能特性

- **多网口多队列支持**：支持多张网卡，每张网卡多个收发队列
- **多核心架构**：支持一个核心处理1个或多个队列的数据包
- **生产者-消费者模式**：基于DPDK的rte_ring实现无锁队列，支持m:n模式
- **五元组流表管理**：自动建立和维护数据流的五元组信息
- **灵活配置**：支持命令行配置网口、核心分配、队列映射

## 系统要求

- Linux系统
- DPDK环境（头文件和静态库已包含）
- 支持DPDK的网卡（如Intel X710、i40e等）
- 至少2GB的hugepages内存

## 编译

```bash
make clean
make
```

## 运行参数

### EAL参数
- `-l <core_list>`：指定使用的CPU核心列表，如 `-l 0-6`
- `--socket-mem=<mem>`：指定socket内存，如 `--socket-mem=2048,2048`
- `--file-prefix=<prefix>`：指定共享文件前缀

### 应用参数
- `-p <portmask>`：端口掩码，十六进制格式，如 `-p 0x3` 表示使用端口0和1
- `-q <queue_config>`：队列配置，格式：`port0:4,port1:4`
- `-r <rx_cores>`：RX核心配置，格式：`1:port0.0-3,2:port1.0-1,3:port1.2-3`  
- `-w <worker_cores>`：Worker核心配置，格式：`4,5,6`

## 使用示例

### 示例1：32核心环境，X710双端口配置
```bash
sudo ./bin/dpdk_multi_port \
    -l 0-6 \
    --socket-mem=2048,2048 \
    --file-prefix=multiport \
    -- \
    -p 0x3 \
    -q port0:4,port1:4 \
    -r 1:port0.0-3,2:port1.0-1,3:port1.2-3 \
    -w 4,5,6
```

这个配置实现了你需求中的场景：
- 1号核心处理port0的4个收发队列（队列0-3）
- 2号核心处理port1的1和2收发队列（队列0-1）  
- 3号核心处理port1的3和4号收发队列（队列2-3）
- 4、5、6号核心作为业务处理核心

### 示例2：简化测试配置
```bash
sudo ./bin/dpdk_multi_port \
    -l 0-5 \
    --socket-mem=1024,1024 \
    -- \
    -p 0x3 \
    -q port0:2,port1:2 \
    -r 1:port0.0-1,2:port1.0-1 \
    -w 4,5
```

## 架构说明

### 核心分工
- **主核心（core 0）**：负责程序初始化、统计输出和信号处理
- **RX核心（生产者）**：负责从网卡队列接收数据包，进行负载均衡后放入ring队列
- **Worker核心（消费者）**：负责从ring队列接收数据包，进行业务处理和流表管理

### 数据流程
1. RX核心从配置的网卡队列批量接收数据包
2. 基于五元组哈希进行负载均衡，选择目标Worker核心
3. 将数据包通过rte_ring无锁队列发送给Worker核心
4. Worker核心接收数据包，提取五元组，查找或创建流表项
5. 执行业务逻辑处理（可根据需求自定义）
6. 更新流表统计信息

### 五元组流表
- 支持IPv4的TCP、UDP、ICMP协议
- 自动流老化机制（可配置超时时间）
- 流统计信息：包数量、字节数、首次/最后发现时间等

## 性能优化

- 使用DPDK批量收发包（burst模式）
- CPU亲和性绑定，避免核心间迁移
- 无锁rte_ring队列，支持高并发
- 预取和分支预测优化
- 零拷贝数据包处理

## 监控和统计

程序运行时会实时显示：
- 每个RX核心的收包统计
- 每个Worker核心的处理统计  
- Ring队列的使用情况
- 流表的统计信息

按Ctrl+C可以优雅退出程序并显示最终统计结果。

## 自定义业务逻辑

在 `src/worker_core.c` 的 `process_packet_business_logic()` 函数中可以添加自定义的业务处理逻辑，例如：
- DPI (Deep Packet Inspection)
- 应用层协议识别
- 流量分类和QoS
- 安全检测
- 数据采集和分析

## 注意事项

1. 需要root权限运行
2. 确保网卡已绑定到DPDK驱动（如vfio-pci）
3. 配置足够的hugepages内存
4. 核心配置要与实际硬件匹配
5. 网卡端口号要与系统中的实际端口对应